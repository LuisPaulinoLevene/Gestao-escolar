<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistências Mútuas</title>
<style>
body { font-family: Arial, sans-serif; background:#f1f5f9; margin:0; padding:0; }
.container { max-width:1400px; margin:50px auto; background:white; padding:30px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,.1); overflow-x:auto; }
h1 { text-align:center; margin-bottom:20px; color:#0f172a; }
form { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px; }
form input, form select { padding:10px; border-radius:6px; border:1px solid #cbd5e1; flex:1; min-width:150px; }
form button { padding:10px 20px; border:none; border-radius:6px; background:#06b6d4; color:white; cursor:pointer; transition:.3s; }
form button:hover { background:#0891b2; }
table { width:100%; border-collapse:collapse; margin-top:20px; min-width:1200px; }
table th, table td { border:1px solid #cbd5e1; padding:10px; text-align:left; font-size:14px; }
table th { background:#06b6d4; color:white; }
.actions button { margin-right:5px; padding:5px 10px; border:none; border-radius:4px; cursor:pointer; }
.actions .edit { background:#22c55e; color:white; }
.actions .delete { background:#ef4444; color:white; }
.status-checkboxes { display:flex; gap:20px; margin-bottom:15px; }
.status-checkboxes label { font-weight:bold; }
</style>
</head>
<body>

<div class="container">
<h1>Planificar  Assistências Mútuas</h1>

<form id="formAssistencia">
<input type="hidden" id="assistenciaId">

<select id="professor_assistido_nome" required>
    <option value="">Professor Assistido</option>
</select>

<select id="professor_assistente_nome" required>
    <option value="">Professor Assistente</option>
</select>

<input type="text" id="classe" placeholder="Classe" required>
<input type="text" id="turma" placeholder="Turma" required>
<input type="text" id="disciplina" placeholder="Disciplina" required>
<input type="text" id="numero_sala" placeholder="Número da Sala" required>
<input type="text" id="localizacao_sala" placeholder="Localização da Sala" required>

<select id="trimestre" required>
    <option value="">Trimestre</option>
    <option value="1">1º</option>
    <option value="2">2º</option>
    <option value="3">3º</option>
</select>

<input type="datetime-local" id="data_hora" required>
<button type="submit">Salvar</button>
</form>

<div class="status-checkboxes">
<label><input type="checkbox" id="trimestre1" onchange="alterarStatusTrimestre(1, this.checked)"> Aprovar 1º Trimestre</label>
<label><input type="checkbox" id="trimestre2" onchange="alterarStatusTrimestre(2, this.checked)"> Aprovar 2º Trimestre</label>
<label><input type="checkbox" id="trimestre3" onchange="alterarStatusTrimestre(3, this.checked)"> Aprovar 3º Trimestre</label>
</div>

<table>
<thead>
<tr>
<th>ID</th><th>Assistido</th><th>Assistente</th><th>Classe</th><th>Turma</th><th>Disciplina</th><th>Nº Sala</th><th>Localização</th><th>Trimestre</th><th>Data/Hora</th><th>Status</th><th>Criado Em</th><th>Ações</th>
</tr>
</thead>
<tbody id="assistenciasBody"></tbody>
</table>
</div>

<script>
const API = "http://127.0.0.1:8000";

// Carregar dropdown de professores
async function carregarProfessores(){
    const res = await fetch(`${API}/assistencias/professores`);
    const dados = await res.json();
    const assistido = document.getElementById("professor_assistido_nome");
    const assistente = document.getElementById("professor_assistente_nome");
    assistido.innerHTML = '<option value="">Professor Assistido</option>';
    assistente.innerHTML = '<option value="">Professor Assistente</option>';
    dados.forEach(p=>{
        assistido.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
        assistente.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
    });
}

// Listar assistências
async function listar(){
    const res = await fetch(`${API}/assistencias/`);
    const dados = await res.json();
    const tbody = document.getElementById("assistenciasBody");
    tbody.innerHTML = "";
    dados.forEach(a=>{
        tbody.innerHTML += `<tr>
            <td>${a.id}</td>
            <td>${a.professor_assistido_nome}</td>
            <td>${a.professor_assistente_nome}</td>
            <td>${a.classe}</td>
            <td>${a.turma}</td>
            <td>${a.disciplina}</td>
            <td>${a.numero_sala}</td>
            <td>${a.localizacao_sala}</td>
            <td>${a.trimestre}</td>
            <td>${new Date(a.data_hora).toLocaleString()}</td>
            <td>${a.status_aprovacao}</td>
            <td>${new Date(a.criado_em).toLocaleString()}</td>
            <td class="actions">
                <button class="edit" onclick="editar(${a.id})">Editar</button>
                <button class="delete" onclick="deletar(${a.id})">Apagar</button>
            </td>
        </tr>`;
    });
}

// Salvar ou atualizar
async function salvar(e){
    e.preventDefault();
    const id = document.getElementById("assistenciaId").value;
    const professorAssistidoId = document.getElementById("professor_assistido_nome").value;
    const professorAssistenteId = document.getElementById("professor_assistente_nome").value;
    const dataHora = document.getElementById("data_hora").value;
    const formattedDate = dataHora.replace("T"," ");
    const dados = {
        professor_assistido_id: Number(professorAssistidoId),
        professor_assistente_id: Number(professorAssistenteId),
        classe: document.getElementById("classe").value,
        turma: document.getElementById("turma").value,
        disciplina: document.getElementById("disciplina").value,
        numero_sala: document.getElementById("numero_sala").value,
        localizacao_sala: document.getElementById("localizacao_sala").value,
        trimestre: document.getElementById("trimestre").value,
        data_hora: formattedDate
    };

    try{
        if(id){
            await fetch(`${API}/assistencias/id/${id}`, {
                method:"PUT",
                headers:{"Content-Type":"application/json"},
                body: JSON.stringify(dados)
            });
        }else{
            await fetch(`${API}/assistencias/`, {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body: JSON.stringify(dados)
            });
        }
        document.getElementById("formAssistencia").reset();
        document.getElementById("assistenciaId").value = "";
        listar();
    }catch(err){
        console.error("Erro ao salvar assistência:", err);
        alert("Erro ao salvar assistência.");
    }
}

// Editar
async function editar(id){
    const res = await fetch(`${API}/assistencias/id/${id}`);
    const a = await res.json();
    document.getElementById("assistenciaId").value = a.id;
    document.getElementById("professor_assistido_nome").value = a.professor_assistido_nome;
    document.getElementById("professor_assistente_nome").value = a.professor_assistente_nome;
    document.getElementById("classe").value = a.classe;
    document.getElementById("turma").value = a.turma;
    document.getElementById("disciplina").value = a.disciplina;
    document.getElementById("numero_sala").value = a.numero_sala;
    document.getElementById("localizacao_sala").value = a.localizacao_sala;
    document.getElementById("trimestre").value = a.trimestre;
    document.getElementById("data_hora").value = a.data_hora.slice(0,16);
}

// Deletar
async function deletar(id){
    if(confirm("Deseja realmente apagar esta assistência?")){
        await fetch(`${API}/assistencias/id/${id}`, {method:"DELETE"});
        listar();
    }
}

// Aprovar/Desaprovar trimestre
async function alterarStatusTrimestre(trimestre, checked){
    const status = checked ? "APROVADO":"NAO";
    const url = new URL(`${API}/assistencias/aprovar-trimestre`);
    url.searchParams.append("trimestre", trimestre.toString());
    url.searchParams.append("status", status);
    const res = await fetch(url, { method: "PUT" });
    if(!res.ok){
        console.error("Erro ao alterar status:", await res.text());
        alert("Erro ao alterar status do trimestre");
    }else{
        listar();
    }
}

document.getElementById("formAssistencia").addEventListener("submit", salvar);
carregarProfessores();
listar();
</script>

</body>
</html>