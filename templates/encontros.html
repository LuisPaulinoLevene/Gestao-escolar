<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Gestão de Encontros - EP Phandira-2</title>
<style>
body { font-family: Arial, sans-serif; background:#f1f5f9; margin:0; padding:0; }
.container { max-width:1200px; margin:50px auto; background:white; padding:30px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); overflow-x:auto; }
h1 { text-align:center; margin-bottom:20px; color:#0f172a; }
form { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:30px; }
form input, form select { padding:10px; border-radius:6px; border:1px solid #cbd5e1; flex:1; min-width:200px; }
form button { padding:10px 20px; border:none; border-radius:6px; background:#06b6d4; color:white; cursor:pointer; transition:.3s; }
form button:hover { background:#0891b2; }
table { width:100%; border-collapse:collapse; margin-top:20px; min-width:1100px; }
table th, table td { border:1px solid #cbd5e1; padding:10px; text-align:left; font-size:14px; }
table th { background:#06b6d4; color:white; }
.actions button { margin-right:5px; padding:5px 10px; border:none; border-radius:4px; cursor:pointer; }
.actions .edit { background:#22c55e; color:white; }
.actions .delete { background:#ef4444; color:white; }
</style>
</head>
<body>

<div class="container">
    <h1>Gestão de Encontros</h1>

    <!-- FORMULÁRIO -->
    <form id="formEncontro">
        <input type="hidden" id="encontroId" value="">
        <input type="text" id="titulo" placeholder="Título do Encontro" required>
        <input type="text" id="descricao" placeholder="Descrição">
        <input type="datetime-local" id="data_hora" required>
        <select id="tipo" required>
            <option value="">Tipo</option>
            <option value="PROFESSORES">PROFESSORES</option>
            <option value="FUNCIONARIOS">FUNCIONÁRIOS</option>
            <option value="TODOS">TODOS</option>
        </select>
        <button type="submit">Salvar</button>
    </form>

    <!-- TABELA DE ENCONTROS -->
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Descrição</th>
                <th>Data/Hora</th>
                <th>Tipo</th>
                <th>Status</th>
                <th>Data Alerta</th>
                <th>Data Convocatória</th>
                <th>Alerta Enviado</th>
                <th>Convocatória Enviada</th>
                <th>Criado Em</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="encontrosBody"></tbody>
    </table>
</div>

<script>
const API_BASE = ""; // base da API (deixe vazio se estiver no mesmo domínio)

// Reset form
function resetForm() {
    document.getElementById("formEncontro").reset();
    document.getElementById("encontroId").value = "";
}

// Normalizar título: minúsculas, sem acentos, sem pontuações finais
function normalizarTitulo(titulo) {
    let t = titulo.toLowerCase();                   // minúsculas
    t = t.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // remover acentos
    t = t.replace(/[.,;!?]+$/g, "");               // remover pontuações finais
    return t.trim();
}

// Formata datas para exibição
function formatarData(dataStr) {
    if (!dataStr) return "";
    const dt = new Date(dataStr);
    return dt.toLocaleString();
}

// Listar encontros
async function listarEncontros() {
    const res = await fetch(`${API_BASE}/encontros/`);
    const dados = await res.json();
    const tbody = document.getElementById("encontrosBody");
    tbody.innerHTML = "";
    dados.forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${e.id}</td>
            <td>${e.titulo}</td>
            <td>${e.descricao || ""}</td>
            <td>${formatarData(e.data_hora)}</td>
            <td>${e.tipo}</td>
            <td>${e.status}</td>
            <td>${formatarData(e.data_alerta)}</td>
            <td>${formatarData(e.data_convocatoria)}</td>
            <td>${e.alerta_enviado}</td>
            <td>${e.convocatoria_enviada}</td>
            <td>${formatarData(e.criado_em)}</td>
            <td class="actions">
                <button class="edit" onclick="editar(${e.id})">Editar</button>
                <button class="delete" onclick="deletar(${e.id})">Apagar</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Criar ou atualizar
async function criarOuAtualizarEncontro(e) {
    e.preventDefault();
    const id = document.getElementById("encontroId").value;

    // Normaliza o título
    const tituloInput = document.getElementById("titulo").value;
    const tituloNormalizado = normalizarTitulo(tituloInput);

    let dataHoraInput = document.getElementById("data_hora").value;
    const data_hora = new Date(dataHoraInput);
    const ano = data_hora.getFullYear();
    const mes = String(data_hora.getMonth() + 1).padStart(2, '0');
    const dia = String(data_hora.getDate()).padStart(2, '0');
    const horas = String(data_hora.getHours()).padStart(2, '0');
    const minutos = String(data_hora.getMinutes()).padStart(2, '0');
    const dataFormatada = `${ano}-${mes}-${dia}T${horas}:${minutos}`;

    const dados = {
        titulo: tituloNormalizado,
        descricao: document.getElementById("descricao").value,
        data_hora: dataFormatada,
        tipo: document.getElementById("tipo").value
    };

    if (id) {
        await fetch(`${API_BASE}/encontros/${id}`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(dados)
        });
    } else {
        await fetch(`${API_BASE}/encontros/`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(dados)
        });
    }

    resetForm();
    listarEncontros();
}

// Editar
async function editar(id) {
    const res = await fetch(`${API_BASE}/encontros/${id}`);
    const e = await res.json();
    document.getElementById("encontroId").value = e.id;
    document.getElementById("titulo").value = e.titulo;
    document.getElementById("descricao").value = e.descricao || "";
    const dt = new Date(e.data_hora);
    const mes = String(dt.getMonth() + 1).padStart(2, '0');
    const dia = String(dt.getDate()).padStart(2, '0');
    const horas = String(dt.getHours()).padStart(2, '0');
    const minutos = String(dt.getMinutes()).padStart(2, '0');
    document.getElementById("data_hora").value = `${dt.getFullYear()}-${mes}-${dia}T${horas}:${minutos}`;
    document.getElementById("tipo").value = e.tipo;
}

// Deletar
async function deletar(id) {
    if (confirm("Tem certeza que deseja apagar este encontro?")) {
        await fetch(`${API_BASE}/encontros/${id}`, { method: "DELETE" });
        listarEncontros();
    }
}

// EVENTOS
document.getElementById("formEncontro").addEventListener("submit", criarOuAtualizarEncontro);
listarEncontros();
</script>

</body>
</html>
